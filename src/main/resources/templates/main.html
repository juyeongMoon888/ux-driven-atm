<!DOCTYPE html>
<html>
<head>
    <title>ATM 메인</title>
</head>
<body>
<h1>ATM 시스템</h1>
<p id="greeting"></p>
<!--로그인/로그아웃 버튼 -->
<button id ="loginBtn" onclick="location.href='/login'">로그인</button>
<button id="logoutBtn" style="display:none;">로그아웃</button>

<!--입출금 버튼 -->
<button onclick="location.href='/banking'">입출금</button>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const token = localStorage.getItem("token");
        const loginBtn = document.getElementById("loginBtn");
        const logoutBtn = document.getElementById("logoutBtn");
        const greetingEl = document.getElementById("greeting");

        if (token) {
            loginBtn.style.display = "none";
            logoutBtn.style.display = "block";

            fetch("/api/users/me",  {
                headers: {
                    Authorization: "Bearer " + token
                }
            })
            .then(res => {
                if (!res.ok) {
                    if (res.status === 401) {
                        localStorage.removeItem("token");
                        alert("세션이 만료되었습니다. 다시 로그인해주세요.");
                        console.log("401 상태 감지됨 - 로그인 페이지로 이동 예정");
                        //location.href = "/login.html";
                    }
                    throw new Error ("토큰이 만료되었거나 유효하지 않습니다.");
                }
                return res.json();
            })
            .then(data => {
                if (greetingEl) {
                    greetingEl.textContent = `안녕하세요, ${data.name}님`;
                }
            })
            .catch(err => {
                console.warn(err.message);
                localStorage.removeItem("token");
                location.reload();
            });
        } else {
            loginBtn.style.display = "block";
            logoutBtn.style.display = "none";
        }

        logoutBtn.addEventListener("click", () => {
            localStorage.removeItem("token");
            location.reload();
        });
    });
</script>
</body>
</html>